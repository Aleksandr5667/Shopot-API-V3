Вот код для добавления в routes.ts:

1. Исправить ответ /api/users/online (строка ~1174):
Было:

return sendSuccess(res, { onlineUserIds });

Стало:

return sendSuccess(res, { userIds: onlineUserIds });

2. Добавить эндпоинты (вставить перед return httpServer;):
// Mark message as read
app.put("/api/messages/:id/read", authenticateToken, async (req: Request, res: Response) => {
  try {
    const messageId = parseInt(req.params.id);
    if (isNaN(messageId)) {
      return sendError(res, "Некорректный ID сообщения");
    }
    const message = await storage.getMessageById(messageId);
    if (!message) {
      return sendError(res, "Сообщение не найдено", 404);
    }
    const chat = await storage.getChatById(message.chatId, req.user!.userId);
    if (!chat) {
      return sendError(res, "Сообщение не найдено", 404);
    }
    await storage.markMessageRead(messageId, req.user!.userId);
    // Notify sender via WebSocket
    const wsService = getWebSocketService();
    if (wsService && message.senderId !== req.user!.userId) {
      wsService.sendToUser(message.senderId, {
        type: 'message:read',
        payload: {
          messageId,
          chatId: message.chatId,
          readByUserId: req.user!.userId,
          readAt: new Date().toISOString()
        }
      });
    }
    return sendSuccess(res, { read: true });
  } catch (error) {
    console.error("Mark message read error:", error);
    return sendError(res, "Ошибка сервера", 500);
  }
});
// Mark chat as read (all messages)
app.put("/api/chats/:id/read", authenticateToken, async (req: Request, res: Response) => {
  try {
    const chatId = parseInt(req.params.id);
    if (isNaN(chatId)) {
      return sendError(res, "Некорректный ID чата");
    }
    const chat = await storage.getChatById(chatId, req.user!.userId);
    if (!chat) {
      return sendError(res, "Чат не найден", 404);
    }
    await storage.markChatRead(chatId, req.user!.userId);
    // Notify other chat members via WebSocket
    const wsService = getWebSocketService();
    if (wsService) {
      const memberIds = await storage.getChatMemberIds(chatId);
      for (const memberId of memberIds) {
        if (memberId !== req.user!.userId) {
          wsService.sendToUser(memberId, {
            type: 'chat:read',
            payload: {
              chatId,
              readByUserId: req.user!.userId,
              readAt: new Date().toISOString()
            }
          });
        }
      }
    }
    return sendSuccess(res, { read: true });
  } catch (error) {
    console.error("Mark chat read error:", error);
    return sendError(res, "Ошибка сервера", 500);
  }
});
// Register push token
app.post("/api/users/push-token", authenticateToken, async (req: Request, res: Response) => {
  try {
    const { pushToken } = req.body;
    if (!pushToken || typeof pushToken !== 'string') {
      return sendError(res, "pushToken обязателен");
    }
    await storage.savePushToken(req.user!.userId, pushToken);
    return sendSuccess(res, { registered: true });
  } catch (error) {
    console.error("Register push token error:", error);
    return sendError(res, "Ошибка сервера", 500);
  }
});
// Remove push token
app.delete("/api/users/push-token", authenticateToken, async (req: Request, res: Response) => {
  try {
    await storage.removePushToken(req.user!.userId);
    return sendSuccess(res, { removed: true });
  } catch (error) {
    console.error("Remove push token error:", error);
    return sendError(res, "Ошибка сервера", 500);
  }
});

3. Добавить методы в storage.ts:
async markMessageRead(messageId: number, userId: number): Promise<void> {
  await db.update(messages)
    .set({ readAt: new Date() })
    .where(and(
      eq(messages.id, messageId),
      isNull(messages.readAt)
    ));
}
async markChatRead(chatId: number, userId: number): Promise<void> {
  await db.update(messages)
    .set({ readAt: new Date() })
    .where(and(
      eq(messages.chatId, chatId),
      ne(messages.senderId, userId),
      isNull(messages.readAt)
    ));
}
async savePushToken(userId: number, token: string): Promise<void> {
  await db.update(users)
    .set({ pushToken: token })
    .where(eq(users.id, userId));
}
async removePushToken(userId: number): Promise<void> {
  await db.update(users)
    .set({ pushToken: null })
    .where(eq(users.id, userId));
}

4. Добавить в schema.ts (если нет):
// В таблице users добавить:
pushToken: text("push_token"),
// В таблице messages добавить (если нет):
readAt: timestamp("read_at"),