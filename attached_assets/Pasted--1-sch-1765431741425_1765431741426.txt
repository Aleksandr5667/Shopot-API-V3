üìã –ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç: –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –±–µ–∫–µ–Ω–¥–µ
‚úÖ –£–ñ–ï –°–î–ï–õ–ê–ù–û (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ):
#	–§–∞–π–ª	–ò–∑–º–µ–Ω–µ–Ω–∏–µ	–°—Ç–∞—Ç—É—Å
1	schema.ts	–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ pushToken –≤ —Ç–∞–±–ª–∏—Ü—É users	‚úÖ –ì–æ—Ç–æ–≤–æ
2	storage.ts	–î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å IStorage	‚úÖ –ì–æ—Ç–æ–≤–æ
3	storage.ts	–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–µ—Ç–æ–¥—ã: markMessageRead, markChatRead, savePushToken, removePushToken	‚úÖ –ì–æ—Ç–æ–≤–æ
4	routes.ts	–≠–Ω–¥–ø–æ–∏–Ω—Ç PUT /api/messages/:id/read	‚úÖ –ì–æ—Ç–æ–≤–æ
5	routes.ts	–≠–Ω–¥–ø–æ–∏–Ω—Ç PUT /api/chats/:id/read	‚úÖ –ì–æ—Ç–æ–≤–æ
6	routes.ts	–≠–Ω–¥–ø–æ–∏–Ω—Ç POST /api/users/push-token	‚úÖ –ì–æ—Ç–æ–≤–æ
7	routes.ts	–≠–Ω–¥–ø–æ–∏–Ω—Ç DELETE /api/users/push-token	‚úÖ –ì–æ—Ç–æ–≤–æ
8	routes.ts	–ò–∑–º–µ–Ω—ë–Ω –æ—Ç–≤–µ—Ç GET /api/users/online: onlineUserIds ‚Üí userIds	‚úÖ –ì–æ—Ç–æ–≤–æ
9	–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö	–ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞	‚úÖ –ì–æ—Ç–æ–≤–æ
‚ùå –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨ (–µ—â—ë –Ω–µ —Å–¥–µ–ª–∞–Ω–æ):
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ edited –≤ —Ç–∞–±–ª–∏—Ü—É messages
–ü—Ä–æ–±–ª–µ–º–∞: –í routes.ts –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è WebSocket —Å–æ–±—ã—Ç–∏–µ —Å edited: true, –Ω–æ —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∏–≥–¥–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–≤–∏–¥–∏—Ç —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ.

–§–∞–π–ª: schema.ts ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü—É messages:

export const messages = pgTable("messages", {
  id: integer("id").primaryKey().generatedAlwaysAsIdentity(),
  chatId: integer("chat_id").notNull().references(() => chats.id, { onDelete: "cascade" }),
  senderId: integer("sender_id").notNull().references(() => users.id, { onDelete: "cascade" }),
  content: text("content"),
  type: messageTypeEnum("type").notNull().default("text"),
  mediaUrl: text("media_url"),
  replyToId: integer("reply_to_id").$type<number | null>().references((): any => messages.id, { onDelete: "set null" }),
  edited: timestamp("edited"),  // ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ö–£
  createdAt: timestamp("created_at").notNull().defaultNow(),
  readBy: integer("read_by").array().notNull().default(sql`ARRAY[]::integer[]`),
});

2. –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–æ–¥ updateMessage –≤ storage.ts
–§–∞–π–ª: storage.ts ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ updateMessage:

–ë—ã–ª–æ:

async updateMessage(messageId: number, content: string): Promise<Message | undefined> {
  const [updated] = await db
    .update(messages)
    .set({ content })
    .where(eq(messages.id, messageId))
    .returning();
  return updated || undefined;
}

–°—Ç–∞–ª–æ:

async updateMessage(messageId: number, content: string): Promise<Message | undefined> {
  const [updated] = await db
    .update(messages)
    .set({ 
      content,
      edited: new Date()  // ‚Üê –î–û–ë–ê–í–ò–¢–¨
    })
    .where(eq(messages.id, messageId))
    .returning();
  return updated || undefined;
}

3. –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

npm run db:push

–∏–ª–∏

npx drizzle-kit push

üìå –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û (–Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ):
–≠—Ç–∏ –∑–∞–¥–∞—á–∏ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É, –Ω–æ –∏—Ö –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

#	–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å	–ì–¥–µ
1	–û–±—Ä–∞–±–æ—Ç–∫–∞ WebSocket —Å–æ–±—ã—Ç–∏—è message:read	services/websocket.ts
2	–û–±—Ä–∞–±–æ—Ç–∫–∞ WebSocket —Å–æ–±—ã—Ç–∏—è chat:read	services/websocket.ts
3	–¢–∏–ø Message –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–µ edited?: string	store/types.ts, services/api.ts
üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞:
–ö–∞—Ç–µ–≥–æ—Ä–∏—è	–í—Å–µ–≥–æ	–°–¥–µ–ª–∞–Ω–æ	–û—Å—Ç–∞–ª–æ—Å—å
–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ schema.ts	2	1	1
–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ storage.ts	5	4	1
–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ routes.ts	5	5	0
–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î	2	1	1
–ò–¢–û–ì–û –Ω–∞ –±–µ–∫–µ–Ω–¥–µ	14	11	3
üîß –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∑–∞–¥–∞—á:
schema.ts ‚Äî –¥–æ–±–∞–≤–∏—Ç—å edited: timestamp("edited") –≤ —Ç–∞–±–ª–∏—Ü—É messages
storage.ts ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ updateMessage (–¥–æ–±–∞–≤–∏—Ç—å edited: new Date())
–¢–µ—Ä–º–∏–Ω–∞–ª ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å npm run db:push
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
