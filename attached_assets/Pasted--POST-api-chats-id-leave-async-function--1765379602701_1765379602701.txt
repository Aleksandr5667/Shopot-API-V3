Передача владения при выходе создателя
Эндпоинт: POST /api/chats/:id/leave

Логика:

async function leaveGroup(chatId, userId) {
  const chat = await getChat(chatId);
  const members = await getChatMembers(chatId);
  const remainingMembers = members.filter(m => m.userId !== userId);
  
  // Если выходит создатель группы
  if (userId === chat.createdById) {
    if (remainingMembers.length > 0) {
      // Находим старейшего участника по дате присоединения
      const oldestMember = remainingMembers.sort(
        (a, b) => new Date(a.joinedAt) - new Date(b.joinedAt)
      )[0];
      
      // Передаём владение (обновляем createdById в таблице chats)
      await db.update('chats')
        .set({ createdById: oldestMember.userId })
        .where({ id: chatId });
      
      // Делаем нового владельца админом (если ещё не админ)
      await db.update('chat_members')
        .set({ role: 'admin' })
        .where({ chatId, userId: oldestMember.userId });
      
      // Отправляем WebSocket событие о смене владельца
      broadcastToChat(chatId, {
        type: 'group_owner_changed',
        chatId: chatId,
        previousOwnerId: userId,
        newOwnerId: oldestMember.userId
      });
    } else {
      // Если участников не осталось - удаляем группу
      await deleteChat(chatId);
      
      broadcastToChat(chatId, {
        type: 'chat_deleted',
        chatId: chatId
      });
      
      return { success: true };
    }
  }
  
  // Удаляем пользователя из группы
  await db.delete('chat_members')
    .where({ chatId, userId });
  
  // Отправляем событие о выходе участника
  broadcastToChat(chatId, {
    type: 'group_member_left',
    chatId: chatId,
    userId: userId
  });
  
  return { success: true };
}
2. Ограничение прав: только создатель может менять роли
Эндпоинт: PUT /api/chats/:chatId/members/:userId/role

async function changeRole(chatId, targetUserId, newRole, requestingUserId) {
  const chat = await getChat(chatId);
  
  // ПРОВЕРКА: только создатель может менять роли
  if (requestingUserId !== chat.createdById) {
    return res.status(403).json({ 
      success: false,
      error: "Only the group creator can change member roles" 
    });
  }
  
  // Нельзя менять роль создателя
  if (targetUserId === chat.createdById) {
    return res.status(403).json({ 
      success: false,
      error: "Cannot change the creator's role" 
    });
  }
  
  // Обновляем роль
  await db.update('chat_members')
    .set({ role: newRole })
    .where({ chatId, userId: targetUserId });
  
  // WebSocket событие
  broadcastToChat(chatId, {
    type: 'group_role_changed',
    chatId: chatId,
    userId: targetUserId,
    role: newRole,
    changedBy: requestingUserId
  });
  
  return { success: true };
}
3. Ограничение прав: только создатель может удалять участников
Эндпоинт: DELETE /api/chats/:chatId/members/:userId

async function removeMember(chatId, targetUserId, requestingUserId) {
  const chat = await getChat(chatId);
  
  // ПРОВЕРКА: только создатель может удалять участников
  if (requestingUserId !== chat.createdById) {
    return res.status(403).json({ 
      success: false,
      error: "Only the group creator can remove members" 
    });
  }
  
  // Нельзя удалить создателя
  if (targetUserId === chat.createdById) {
    return res.status(403).json({ 
      success: false,
      error: "Cannot remove the group creator" 
    });
  }
  
  // Удаляем участника
  await db.delete('chat_members')
    .where({ chatId, userId: targetUserId });
  
  // WebSocket событие
  broadcastToChat(chatId, {
    type: 'group_member_removed',
    chatId: chatId,
    userId: targetUserId,
    removedBy: requestingUserId
  });
  
  return { success: true };
}
4. Добавление участников: создатель ИЛИ админы
Эндпоинт: POST /api/chats/:chatId/members

async function addMembers(chatId, newUserIds, requestingUserId) {
  const member = await db.select('chat_members')
    .where({ chatId, userId: requestingUserId })
    .first();
  
  // ПРОВЕРКА: только админы (включая создателя) могут добавлять
  if (!member || member.role !== 'admin') {
    return res.status(403).json({ 
      success: false,
      error: "Only admins can add members" 
    });
  }
  
  // Добавляем новых участников
  for (const userId of newUserIds) {
    await db.insert('chat_members').values({
      chatId,
      userId,
      role: 'member',
      joinedAt: new Date()
    });
    
    const user = await getUser(userId);
    
    // WebSocket событие для каждого добавленного
    broadcastToChat(chatId, {
      type: 'group_member_added',
      chatId: chatId,
      userId: userId,
      addedBy: requestingUserId,
      user: user
    });
  }
  
  return { success: true };
}
5. Новое WebSocket событие
Тип: group_owner_changed

Payload:

{
  "type": "group_owner_changed",
  "chatId": 123,
  "previousOwnerId": 456,
  "newOwnerId": 789
}
Сводная таблица прав
Действие	Создатель	Админ	Участник
Добавлять участников	✅	✅	❌
Удалять участников	✅	❌	❌
Назначать/снимать админов	✅	❌	❌
Менять название/аватар группы	✅	✅	❌
Выйти из группы	✅ (передача владения)	✅	✅
Это все изменения! Когда реализуешь - дай знать, проверим вместе.